{% extends "base.html" %}

{% block content %}
<h2>{{ book[1] }}</h2>

<div class="mb-4">
  {% set author_contributors = contributors.get('author', []) %}
  <p><strong>Author(s):</strong>
    {% if author_contributors %}
      {% for contributor in author_contributors %}
        <a href="{{ url_for('main.view_person', person_id=contributor[0]) }}">{{ contributor[1] }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
    {% else %}
      —
    {% endif %}
  </p>
  {% set translator_contributors = contributors.get('translator', []) %}
  <p><strong>Translator(s):</strong>
    {% if translator_contributors %}
      {% for contributor in translator_contributors %}
        <a href="{{ url_for('main.view_person', person_id=contributor[0]) }}">{{ contributor[1] }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
    {% else %}
      —
    {% endif %}
  </p>
  <p><strong>Publication Year:</strong> {{ book[2] or '—' }}</p>
  <p><strong>ISBN:</strong> {{ book[3] or '—' }}</p>
  <p><strong>Status:</strong> {% if book[6] %}<span class="badge bg-success">Complete</span>{% else %}<span class="badge bg-secondary">In Progress</span>{% endif %}</p>
</div>

<div class="d-flex gap-2 my-3">
  <a href="{{ url_for('main.edit_book', book_id=book[0]) }}" class="btn btn-outline-secondary">Edit Book</a>
  {% if not book[6] %}
    <a href="{{ url_for('main.add_epigraph') }}?book_id={{ book[0] }}" class="btn btn-outline-secondary">Add Epigraph</a>
    <a href="{{ url_for('main.add_citation') }}?book_id={{ book[0] }}" class="btn btn-primary">Add Referent</a>
  {% endif %}
</div>

{% if epigraphs %}
<h4 class="mt-4">Epigraphs</h4>
<ul class="list-group">
  {% for epigraph in epigraphs %}
  <li class="list-group-item d-flex justify-content-between align-items-start">
    <div class="me-3 flex-grow-1">
      <div class="mb-2"><strong>{{ epigraph[3] }}</strong></div>
      <div class="p-3 bg-light border rounded" style="white-space: pre-wrap;">
        {{- epigraph[1] -}}
      </div>
      {% if epigraph[2] %}
      <div class="mt-2">
        <button class="btn btn-sm btn-link p-0" data-bs-toggle="collapse" data-bs-target="#book-epigraph-note-{{ epigraph[0] }}">
          <i class="bi bi-chat-left-text"></i> Notes
        </button>
        <div class="collapse mt-2" id="book-epigraph-note-{{ epigraph[0] }}">
          <div class="card card-body bg-light" style="white-space: pre-wrap;">
            {{- epigraph[2] -}}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="d-flex flex-column align-items-end gap-2">
      <a href="{{ url_for('main.edit_epigraph', epigraph_id=epigraph[0]) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
      <form method="POST" action="{{ url_for('main.delete_epigraph', epigraph_id=epigraph[0]) }}" onsubmit="return confirm('Delete this epigraph?');" class="d-inline">
        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
      </form>
    </div>
  </li>
  {% endfor %}
</ul>
{% else %}
<p class="mt-4 text-muted">No epigraphs yet for this book.</p>
{% endif %}

{% if citations %}
<h4 class="mt-4">Referents</h4>
<ul class="list-group">
  {% for citation in citations %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <strong>{{ citation[1] }}</strong> on page {{ citation[2] }}
            {% if citation[5] %}
              <i class="bi bi-journal-minus ms-2 text-info" title="Indirect citation"></i>
            {% endif %}
            {% if citation[4] %}
            <button class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="collapse" data-bs-target="#note-{{ citation[0] }}">
                <i class="bi bi-chat-left-text-fill" title="Show note"></i>
            </button>
            <div class="collapse mt-2 w-75" id="note-{{ citation[0] }}">
                <div class="card card-body text-bg-info" style="white-space: pre-wrap;">
                {{- citation[4] -}}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="btn-group">
            <a href="{{ url_for('main.view_person', person_id=citation[3]) }}" class="btn btn-sm btn-outline-primary">View Person</a>
            <a href="{{ url_for('main.edit_citation', citation_id=citation[0]) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
        </div>
    </li>
  {% endfor %}
</ul>
{% else %}
<p class="mt-4 text-muted">No citations yet for this book.</p>
{% endif %}

<a href="{{ url_for('main.books') }}" class="btn btn-outline-primary mt-3">Back to Books</a>
{% endblock %}
